<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Publishing private composer packages to Artifactory with Jenkins</title>
  <meta name="description" content="This is a quick guide for how to publish a custom Composer package to Artifactory with Jenkins in a way that behaves similarly to Packagist. The version will...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://meh.dev/publish-private-composer-package-to-artifactory-with-jenkins">
  <link rel="alternate" type="application/rss+xml" title="meh.dev" href="https://meh.dev/feed.xml">
</head>


  <body>

    <header class="site-header">
  <div class="wrapper">
    <a class="site-title" href="/">
      <img src="https://0.gravatar.com/avatar/ccf00de89ec54577fb9fd612358a9808?s=56">
      meh.dev
    </a>
    <nav class="site-nav">
      <a class="page-link" href="/cv">CV</a>
      <a class="page-link" href="/archive">Archive</a>
    </nav>
  </div>
</header>


    <div class="wrapper">
      

<article class="post content-wrapper content-style-green" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Publishing private composer packages to Artifactory with Jenkins</h2>
    <div class="post-meta">
        <div class="post-meta-text">
          <div class="post-meta-icon">
            <i class="far fa-calendar"></i>
          </div>
          Posted on 
          <time datetime="2020-04-22T08:00:00+00:00" itemprop="datePublished">
            Apr 22, 2020
          </time>
        </div>
        
        
        
        
        
        <ul class="tag-list">
          
          <li class="inline"><a class="tag-list-link" href="/tag/CI">CI</a></li>
          
          <li class="inline"><a class="tag-list-link" href="/tag/PHP">PHP</a></li>
          
          <li class="inline"><a class="tag-list-link" href="/tag/Composer">Composer</a></li>
          
          <li class="inline"><a class="tag-list-link" href="/tag/Artifactory">Artifactory</a></li>
          
          <li class="inline"><a class="tag-list-link" href="/tag/Jenkins">Jenkins</a></li>
          
        </ul>
        
    </div>
  </header>
  
  <div class="post-content" itemprop="articleBody">
    <p>This is a quick guide for how to publish a custom Composer package to Artifactory with Jenkins in a way that behaves similarly to Packagist. The version will come from a git tag without needing to update the composer.json file.</p>

<h2 id="configuration">Configuration</h2>

<ul>
  <li>
    <p>Setup the <a href="https://www.jfrog.com/confluence/display/JFROG/Jenkins+Artifactory+Plug-in">Jenkins Artifactory Plug-in</a>, this will make things easier since you wont need to manage credentials or make http requests directly from the pipeline.</p>
  </li>
  <li>
    <p>Enable tags as a “Branch Source” in Jenkins. For Github this is under the folder or project settings. “Discover tags” should be an enabled behavior. If this isn’t set you may not see tags be built in Jenkins.</p>
  </li>
  <li>
    <p>Create a local Composer repository in Artifactory. <a href="https://www.jfrog.com/confluence/display/JFROG/PHP+Composer+Repositories">See the JFrog documentation for how to create</a>.</p>
  </li>
</ul>

<h2 id="composerjson">composer.json</h2>

<ul>
  <li>Do not specify a <code class="language-plaintext highlighter-rouge">"version"</code>, it will be populated by Jenkins via a git tag.</li>
  <li>Include <code class="language-plaintext highlighter-rouge">"archive"</code> options since you probably do not want to push up the vendor folder or other things that shouldn’t be part of a package. For instance I exclude tests since consumers of my package wont be running tests, I only need them during CI and development.
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nl">"archive"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
   </span><span class="nl">"exclude"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"/vendor"</span><span class="p">,</span><span class="w"> </span><span class="s2">"/build"</span><span class="p">,</span><span class="w"> </span><span class="s2">"**/Tests/*"</span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<h2 id="archive-creation-in-jenkinsfile">Archive creation in Jenkinsfile</h2>
<p>When creating an archive, we can use the <code class="language-plaintext highlighter-rouge">$TAG_NAME</code> which is supplied by Jenkins. You should change <code class="language-plaintext highlighter-rouge">example</code> to the name of your package.</p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="n">stage</span><span class="o">(</span><span class="s2">"Create Archive"</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">when</span> <span class="o">{</span>
        <span class="n">tag</span> <span class="s1">'*'</span>
    <span class="o">}</span>
    <span class="n">steps</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s2">"php composer.phar archive --format=zip --dir=build --file=example-$TAG_NAME"</span>
        <span class="n">archiveArtifacts</span> <span class="nl">artifacts:</span> <span class="s1">'build/*.zip'</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Note: <code class="language-plaintext highlighter-rouge">archiveArtifacts</code> only archives the artifact to Jenkins, this is optional and can be left out if you only want to push the archive to Artifactory.</p>

<h2 id="publishing-to-artifactory-from-your-jenkinsfile">Publishing to Artifactory from your Jenkinsfile</h2>
<p>When publishing it’s possible to set the version using a property. Since we are using the plugin and we’re providing a <a href="https://www.jfrog.com/confluence/display/JFROG/Using+File+Specs">file spec</a>  we’ll pass it in as a prop. <code class="language-plaintext highlighter-rouge">"props": "composer.version=$TAG_NAME"</code>. If we weren’t using the plugin it would be specified as a url query variable like this: <code class="language-plaintext highlighter-rouge">?properties=composer.version=$TAG_NAME</code>.</p>

<p>In the target, <code class="language-plaintext highlighter-rouge">composer-local</code> is the name of my local Composer repository in Artifactory. Change that to what yours is named and change <code class="language-plaintext highlighter-rouge">example</code> to the name of your package or other path where you want the package published. Do not forget the trailing <code class="language-plaintext highlighter-rouge">/</code> in the target otherwise it will become the filename.</p>

<p>Publishing stage</p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="n">stage</span><span class="o">(</span><span class="s2">"Publish"</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">when</span> <span class="o">{</span>
        <span class="n">tag</span> <span class="s1">'*'</span>
    <span class="o">}</span>
    <span class="n">steps</span> <span class="o">{</span>
        <span class="n">script</span> <span class="o">{</span>
            <span class="kt">def</span> <span class="n">server</span> <span class="o">=</span> <span class="n">Artifactory</span><span class="o">.</span><span class="na">server</span> <span class="s1">'artifactory'</span>
            <span class="kt">def</span> <span class="n">buildInfo</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">upload</span> <span class="nl">spec:</span> <span class="s2">"""{
                "files": [
                    {
                        "pattern": "${env.WORKSPACE}/build/*.zip",
                        "target": "composer-local/example/",
                        "props": "composer.version=$TAG_NAME"
                    }
                ]
            }"""</span>
            <span class="n">server</span><span class="o">.</span><span class="na">publishBuildInfo</span> <span class="n">buildInfo</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>


    

    
    
  </div>

  

  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
    this.page.url = "https://meh.dev/publish-private-composer-package-to-artifactory-with-jenkins";
    this.page.identifier = '/publish-private-composer-package-to-artifactory-with-jenkins';
  };
  (function() {
  var d = document, s = d.createElement('script');
  s.src = 'https://jspaetzel.disqus.com/embed.js';
  s.setAttribute('data-timestamp', +new Date());
  (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view comments</noscript>
  <script id="dsq-count-scr" src="//jspaetzel.disqus.com/count.js" async></script>
</article>


    </div>

    <footer class="footer">
    <div class="copyright">© 2021  <i class="fas fa-heart"></i>  John Spaetzel</div>
</footer>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Josefin Sans', 'Noto Sans', 'Roboto Mono', 'Material Icons']
    }
  });
</script>
<script src="https://kit.fontawesome.com/ea17bff308.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-W3G88JG6ZH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-W3G88JG6ZH');
</script>

  </body>

</html>
